<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>

  <ImportAction name="merge">
    <Configuration name="SystemConfiguration">
      <Attributes>
        <Map>
          <entry key="managerQuickLinks">
            <value>
              <List>
                <QuickLink name="ManagerTransfer" action="workflow" enabled="true" messageKey="ManagerTransfer" category="Custom">
                  <Attributes>
                    <Map>
                      <entry key="workflowName" value="ManagerTransfer" />
                      <entry key="workflowSuccess" value="Update process started..." />
                      <entry key="manager">
                        <value>
                          <Script>
                            <Source>
                              if(currentUser.getManager() == null){
                                return "spadmin";
                              }
                              else{
                                return currentUser.getManager().getName();
                              }
                            </Source>
                          </Script>
                        </value>
                      </entry>

                      <entry key="managerEmail">
                        <value>
                          <Script>
                            <Source>
                              if(currentUser.getManager() == null){
                                return "spadmin@example.com";
                              }
                              else{
                                return currentUser.getManager().getEmail();
                              }
                            </Source>
                          </Script>
                        </value>
                      </entry>
                    </Map>
                  </Attributes>
                </QuickLink>
              </List>
            </value>
          </entry>
        </Map>
      </Attributes>
    </Configuration>
  </ImportAction>

  <Workflow  explicitTransitions="true" libraries="Identity" name="ManagerTransfer" type="LCM">
    
  <!-- input variables from quicklink -->
    <Variable input="true" name="launcher"/>
    <Variable input="true" name="currentUserName"/>
    <Variable input="true" name="quickLinkIdentityId"/>
    <Variable input="true" initializer="string:true" name="trace"/>

    <!-- internal variables -->
    <Variable name="identityName" initializer="script:context.getObjectById(Identity.class,quickLinkIdentityId).getName()"/>

    <Variable name="plan"/>
    <Variable input="true" name="event"/>

    <Variable initializer="script:(identityDisplayName != void) ? identityDisplayName : resolveDisplayName(identityName)" input="true" name="identityDisplayName"/>

    <Variable input="true" name="identityObjt" initializer="script:context.getObjectByName(Identity.class,identityName);"/>

    <Variable input="true" name="identityPass" initializer="script:identityObjt.getPassword();"/>
    <Variable input="true" name="identityEmail" initializer="script:identityObjt.getEmail();"/>
    <Variable input="true" name="managerIdentity" initializer="script:identityObjt.getManager().getName();"/>
    <Variable input="true" name="identityFirstName" initializer="script:identityObjt.getFirstname();"/>
    <Variable input="true" name="identityLastName" initializer="script:identityObjt.getLastname();"/>
    <Variable input="true" name="identityDepartment" initializer='script:identityObjt.getAttribute("department");'/>

    <Variable initializer="AccountsRequest" input="true" name="flow"/>
    <Variable name="ADConnectoraccess"/>
    <Variable name="identityRequestId"/>
    <Variable initializer="manager" input="true" name="fallbackApprover"/>
    <Variable name="project"/>

    <Step icon="Start" name="Start" posX="50" posY="50">
      <Transition to="Display Form"/>
    </Step>

    <Step icon="Message" name="Display Form" posX="100" posY="50">
      <Approval owner="ref:manager" send="identityName" return="ADConnectoraccess">
        <Arg name='workItemDescription' value='Process change user: $(identityName)'/>
        <Arg name="workItemRequester" value="ref:identityName"/>
        <Arg name="workItemNotificationTemplate" value="MoverEmployeeManager"/>
        <Arg name="workItemType" value="ManualAction"/>

        <Arg name="identityPass" value="ref:identityPass"/>
        <Arg name="identityFirstName" value="ref:identityFirstName"/>
        <Arg name="identityLastName" value="ref:identityLastName"/>
        <Arg name="identityEmail" value="ref:identityEmail"/>
        <Arg name="managerIdentity" value="ref:managerIdentity"/>
        <Arg name="identityDepartment" value="ref:identityDepartment"/>
        <Arg name="identityDisplayName" value="ref:identityDisplayName"/>

        <Form name="UserUpdate">
          <Section name='userUpdate' type='text' label='Instructions'>
            <Field name='Directions' value='Update to employee: $(identityName)'/>
          </Section>

          <Section type="datable" label="Login Information">
            <Field displayName="Login Name" name="sAMAccountName" value="$(identityName)" required="true"/>

            <Field displayName="Password" name="password" reviewRequired="true" type="secret" required="true" value="$(identityPass)"/>
            <Field displayName="Password Confirmation" name="passwordConfirm" reviewRequired="true" type="secret" required="true" value="$(identityPass)"/>
          </Section>

          <Section type="datable" label="Account Details">
            <Field displayName="First Name" name="firstName" type="String" value="$(identityFirstName)"/>
            <Field displayName="Last Name" name="sn" type="String" value="$(identityLastName)"/>
            <Field displayName="Email" name="mail" type="String" value="$(identityEmail)" required="true"/>


            <Field displayName="Manager" filterString="managerStatus == true" name="manager" type="sailpoint.object.Identity" value="$(managerIdentity)"/>

            <Field displayName="Department" name="department" type="String" value="$(identityDepartment)">
              <AllowedValues>
                <String>Sales</String>
                <String>Management</String>
                <String>Customer Service</String>
                <String>Software Develop</String>
                <String>Finances</String>
                <String>IT Support</String>
              </AllowedValues>
            </Field>

          </Section>

          <Button label='Submit' action='next'/>
          <Button label='Cancel' action='cancel'/>
        </Form>
      </Approval>
      <Transition to="Create Modify Plan"/>
    </Step>

    <Step icon="Task" name="Create Modify Plan" resultVariable="plan" posX="150" posY="50">
    	<Script>
    		<Source>
    			import sailpoint.object.ProvisioningPlan;
    			import sailpoint.object.ProvisioningPlan.AccountRequest;
    			import sailpoint.object.ProvisioningPlan.AttributeRequest;
    			import java.util.List;
    			import java.util.ArrayList;

    			ProvisioningPlan plan = new ProvisioningPlan();
    			List accreqs = new ArrayList();

    			if (ADConnectoraccess) {
    				AccountRequest acctReq = new AccountRequest();
    				acctReq.setOperation(AccountRequest.Operation.Modify);
    				acctReq.setApplication("AD Connector");
    				accreqs.add(acctReq);
    			}


    			if(plan != null){
					System.out.println("El plan fue creado correctamente.");
					plan.setAccountRequests(accreqs);
					plan.setIdentity(identityObject);
				}
				return plan;
			</Source>
		</Script>
		<Transition to="Initialize"/>
	</Step>

	<Step icon="Task" name="Initialize" posX="200" posY="50">
	    <Arg name="formTemplate" value="Identity Update"/>
	    <Arg name="identityName" value="ref:identityName"/>
	    <Arg name="identityDisplayName" value="ref:identityDisplayName"/>
	    <Arg name="launcher" value="ref:launcher"/>
	    <Arg name="plan" value="ref:plan"/>
	    <Arg name="priority" value="ref:workItemPriority"/>
	    <Arg name="policyScheme" value="none"/>
	    <Arg name="source" value="ref:source"/>
	    <Arg name="trace" value="ref:trace"/>
	    <Arg name="flow" value="ref:flow"/>
    	<Return name="project" to="project"/>
	    <Return name="approvalSet" to="cart"/>
	    <Return name="identityRequestId" to="identityRequestId"/>

	    <WorkflowRef>
	      <Reference class="sailpoint.object.Workflow" name="Identity Request Initialize"/>
	    </WorkflowRef>
	    <Transition to="Provision"/>
	</Step>

	<Step icon="Task" name="Provision" posX="250" posY="50">
	    <Arg name="fallbackApprover" value="ref:fallbackApprover"/>
	    <Arg name="formTemplate" value="Identity Update"/>
	    <Arg name="identityDisplayName" value="ref:identityDisplayName"/>
	    <Arg name="identityName" value="ref:identityName"/>
	    <Arg name="launcher" value="ref:launcher"/>
	    <Arg name="manualActionsEmailTemplate" value="Pending Manual Change"/>
	    <Arg name="project" value="ref:project"/>
	    <Arg name="policyScheme" value="none"/>
	    <Arg name="trace" value="ref:trace"/>
	    <Return name="project" to="project"/>
	    <WorkflowRef>
	      <Reference class="sailpoint.object.Workflow" name="Identity Request Provision"/>
	    </WorkflowRef>
	    <Transition to="Finalize"/>
	</Step>

	<Step catches="complete" icon="Task" name="Finalize" posX="300" posY="50">
		<Arg name="approvalSet" value="ref:cart"/>
		<Arg name="project" value="ref:project"/>
		<Arg name="trace" value="ref:trace"/>
		<WorkflowRef>
			<Reference class="sailpoint.object.Workflow" name="Identity Request Finalize"/>
		</WorkflowRef>
		<Transition to="Refresh Identity"/>
	</Step>

	<Step icon="Task" action="call:refreshIdentity" name="Refresh Identity" posX="350" posY="50">
		<Arg name="identityName" value="ref:identityName"/>
		<Arg name="correlateEntitlements" value="string:true"/>
		<Arg name="provision" value="string:true"/>
		<Transition to="end"/>
	</Step>

    <Step icon="Stop" name="end" posX="400" posY="50"/>
  </Workflow>
</sailpoint>

